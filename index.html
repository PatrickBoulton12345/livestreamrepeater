<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream Repeater</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links a {
            color: #a0a0a0;
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-links a:hover { color: #fff; }

        .btn-login, .btn-signup {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-login {
            border: 1px solid #e94560;
            background: transparent;
            color: #e94560;
        }

        .btn-signup {
            border: none;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            color: #fff;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info { text-align: right; }
        .user-name { font-weight: 600; }
        .user-plan { font-size: 0.8rem; color: #e94560; }
        .btn-logout {
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: transparent;
            color: #a0a0a0;
            cursor: pointer;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #a0a0a0;
            font-size: 1.1rem;
        }

        /* Plan Badge */
        .plan-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
        .plan-badge.free { background: rgba(255,255,255,0.1); color: #a0a0a0; }
        .plan-badge.starter { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .plan-badge.pro { background: rgba(233, 69, 96, 0.2); color: #e94560; }
        .plan-badge.business { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

        /* Upgrade Banner */
        .upgrade-banner {
            background: linear-gradient(90deg, rgba(233, 69, 96, 0.1), rgba(255, 107, 107, 0.1));
            border: 1px solid rgba(233, 69, 96, 0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upgrade-banner p { color: #fff; }
        .upgrade-banner a {
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            color: #fff;
            padding: 8px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed rgba(233, 69, 96, 0.5);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(233, 69, 96, 0.05);
        }

        .upload-area:hover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-area.dragover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.15);
        }

        .upload-area input {
            display: none;
        }

        .upload-area .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-area p {
            color: #a0a0a0;
        }

        .upload-area .supported {
            font-size: 0.85rem;
            margin-top: 10px;
            color: #666;
        }

        /* Video Preview */
        .video-preview {
            margin-top: 20px;
            display: none;
        }

        .video-preview.active {
            display: block;
        }

        .video-preview video {
            width: 100%;
            border-radius: 12px;
            background: #000;
        }

        .video-info {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .video-info p {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .video-info p span {
            color: #fff;
        }

        /* Crop Controls */
        .crop-controls {
            margin-top: 20px;
        }

        .crop-controls h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #e94560;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #e94560;
        }

        .input-group input[type="datetime-local"] {
            color-scheme: dark;
        }

        /* Schedule Section */
        .schedule-section {
            margin-top: 20px;
        }

        .schedule-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .schedule-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schedule-btn:hover,
        .schedule-btn.active {
            border-color: #e94560;
            color: #fff;
            background: rgba(233, 69, 96, 0.2);
        }

        /* Loop Settings */
        .loop-settings {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .loop-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .loop-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #e94560;
        }

        .loop-option input[type="number"] {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        /* Platform Integration */
        .platforms {
            display: grid;
            gap: 15px;
        }

        .platform-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .platform-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .platform-logo {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .platform-logo.meta {
            background: linear-gradient(135deg, #0668E1, #00C6FF);
        }

        .platform-logo.twitter {
            background: #000;
            border: 1px solid #333;
        }

        .platform-name {
            font-weight: 600;
        }

        .platform-status {
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .platform-status.available {
            color: #4ade80;
        }

        .platform-status.unavailable {
            color: #f87171;
        }

        .connect-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .connect-btn.available {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: #fff;
        }

        .connect-btn.available:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        .connect-btn.unavailable {
            background: rgba(255, 255, 255, 0.1);
            color: #666;
            cursor: not-allowed;
        }

        /* RTMP Settings */
        .rtmp-settings {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .rtmp-settings h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #e94560;
        }

        .rtmp-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rtmp-input input {
            flex: 1;
        }

        /* Start Button */
        .start-section {
            grid-column: 1 / -1;
        }

        .start-btn {
            width: 100%;
            padding: 18px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .start-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status Panel */
        .status-panel {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            display: none;
        }

        .status-panel.active {
            display: block;
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.stopped {
            background: #f87171;
            animation: none;
        }

        .stop-btn {
            padding: 10px 20px;
            border: 1px solid #f87171;
            border-radius: 8px;
            background: transparent;
            color: #f87171;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stop-btn:hover {
            background: rgba(248, 113, 113, 0.2);
        }

        .status-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e94560;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-top: 5px;
        }

        /* Notice Banner */
        .notice-banner {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notice-banner .icon {
            font-size: 1.2rem;
        }

        .notice-banner p {
            font-size: 0.9rem;
            color: #fbbf24;
            line-height: 1.5;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 0;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="/" class="logo">StreamLoop</a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/pricing">Pricing</a>
                <div id="authButtons">
                    <button class="btn-login" onclick="window.location.href='/pricing'">Log In</button>
                    <button class="btn-signup" onclick="window.location.href='/pricing'">Sign Up</button>
                </div>
            </div>
        </nav>

        <header>
            <h1>Live Stream Repeater</h1>
            <p>Turn your videos into continuous live streams on social platforms</p>
        </header>

        <div id="upgradeBanner" class="upgrade-banner" style="display: none;">
            <p><strong>Free Plan:</strong> <span id="usageText">0/1 streams used this month</span></p>
            <a href="/pricing">Upgrade for More</a>
        </div>

        <div class="notice-banner" id="serverStatus">
            <span class="icon">&#9888;</span>
            <p><strong>Checking server connection...</strong></p>
        </div>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="card">
                <h2><span class="icon">&#128249;</span> Upload Video</h2>

                <div class="upload-area" id="uploadArea">
                    <input type="file" id="videoInput" accept="video/*">
                    <div class="upload-icon">&#128228;</div>
                    <p><strong>Drop your video here</strong> or click to browse</p>
                    <p class="supported">Supports MP4, MOV, AVI, MKV, WebM</p>
                </div>

                <div class="video-preview" id="videoPreview">
                    <video id="previewPlayer" controls></video>
                    <div class="video-info" id="videoInfo">
                        <p>Filename: <span id="fileName">-</span></p>
                        <p>Duration: <span id="videoDuration">-</span></p>
                        <p>Resolution: <span id="videoResolution">-</span></p>
                        <p>Size: <span id="fileSize">-</span></p>
                    </div>
                </div>

                <div class="crop-controls" id="cropControls" style="display: none;">
                    <h3>&#9986; Trim Video (Optional)</h3>
                    <p style="font-size: 0.85rem; color: #a0a0a0; margin-bottom: 15px;">
                        Set start and end points to loop only a portion of the video
                    </p>
                    <div class="time-inputs">
                        <div class="input-group">
                            <label>Start Time</label>
                            <input type="text" id="startTime" placeholder="00:00:00" value="00:00:00">
                        </div>
                        <div class="input-group">
                            <label>End Time</label>
                            <input type="text" id="endTime" placeholder="00:00:00">
                        </div>
                    </div>
                    <button class="schedule-btn" id="previewTrim" style="margin-top: 10px;">Preview Trimmed Section</button>
                </div>
            </div>

            <!-- Schedule & Settings -->
            <div class="card">
                <h2><span class="icon">&#128337;</span> Schedule & Settings</h2>

                <div class="schedule-section">
                    <div class="schedule-options">
                        <button class="schedule-btn active" data-schedule="now">Start Now</button>
                        <button class="schedule-btn" data-schedule="later">Schedule</button>
                    </div>

                    <div id="scheduleInputs" style="display: none;">
                        <div class="input-group">
                            <label>Start Date & Time</label>
                            <input type="datetime-local" id="scheduleTime">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Stream Duration</label>
                        <select id="streamDuration">
                            <option value="0">Continuous (No Limit)</option>
                            <option value="30">30 Minutes</option>
                            <option value="60">1 Hour</option>
                            <option value="120">2 Hours</option>
                            <option value="240">4 Hours</option>
                            <option value="480">8 Hours</option>
                            <option value="720">12 Hours</option>
                            <option value="1440">24 Hours</option>
                            <option value="custom">Custom Duration</option>
                        </select>
                    </div>

                    <div class="input-group" id="customDuration" style="display: none;">
                        <label>Custom Duration (minutes)</label>
                        <input type="number" id="customDurationValue" placeholder="Enter minutes" min="1">
                    </div>
                </div>

                <div class="loop-settings">
                    <h3 style="font-size: 1rem; margin-bottom: 15px; color: #e94560;">Loop Settings</h3>

                    <div class="loop-option">
                        <input type="checkbox" id="infiniteLoop" checked>
                        <label for="infiniteLoop">Loop indefinitely</label>
                    </div>

                    <div class="loop-option" id="loopCountOption" style="display: none;">
                        <label>Number of loops:</label>
                        <input type="number" id="loopCount" value="1" min="1">
                    </div>

                    <div class="loop-option">
                        <input type="checkbox" id="gapBetweenLoops">
                        <label for="gapBetweenLoops">Add gap between loops (seconds):</label>
                        <input type="number" id="loopGap" value="0" min="0" style="width: 60px;">
                    </div>
                </div>
            </div>

            <!-- Platform Integration -->
            <div class="card">
                <h2><span class="icon">&#128225;</span> Platform Integration</h2>

                <div class="platforms">
                    <div class="platform-card">
                        <div class="platform-info">
                            <div class="platform-logo meta">f</div>
                            <div>
                                <div class="platform-name">Meta (Facebook/Instagram)</div>
                                <div class="platform-status available">API Available</div>
                            </div>
                        </div>
                        <button class="connect-btn available" id="connectMeta">Connect</button>
                    </div>

                    <div class="platform-card">
                        <div class="platform-info">
                            <div class="platform-logo twitter">&#120143;</div>
                            <div>
                                <div class="platform-name">Twitter / X</div>
                                <div class="platform-status unavailable">No Public API</div>
                            </div>
                        </div>
                        <button class="connect-btn unavailable" disabled>Unavailable</button>
                    </div>
                </div>

                <div class="rtmp-settings">
                    <h3>Custom RTMP Destination</h3>
                    <p style="font-size: 0.85rem; color: #a0a0a0; margin-bottom: 15px;">
                        Stream to any platform that supports RTMP (YouTube, Twitch, etc.)
                    </p>
                    <div class="input-group">
                        <label>RTMP Server URL</label>
                        <input type="text" id="rtmpUrl" placeholder="rtmp://live.example.com/live">
                    </div>
                    <div class="input-group">
                        <label>Stream Key</label>
                        <div class="rtmp-input">
                            <input type="password" id="streamKey" placeholder="Your stream key">
                            <button class="schedule-btn" id="toggleKey" style="width: auto; padding: 12px 15px;">Show</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Settings -->
            <div class="card">
                <h2><span class="icon">&#9881;</span> Output Settings</h2>

                <div class="input-group">
                    <label>Output Resolution</label>
                    <select id="outputResolution">
                        <option value="source">Same as Source</option>
                        <option value="1080p">1080p (1920x1080)</option>
                        <option value="720p">720p (1280x720)</option>
                        <option value="480p">480p (854x480)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Frame Rate</label>
                    <select id="frameRate">
                        <option value="source">Same as Source</option>
                        <option value="30">30 fps</option>
                        <option value="60">60 fps</option>
                        <option value="24">24 fps</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Bitrate (kbps)</label>
                    <select id="bitrate">
                        <option value="auto">Auto (Recommended)</option>
                        <option value="6000">6000 kbps (High Quality)</option>
                        <option value="4500">4500 kbps (Standard)</option>
                        <option value="3000">3000 kbps (Medium)</option>
                        <option value="1500">1500 kbps (Low)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Aspect Ratio</label>
                    <select id="aspectRatio">
                        <option value="source">Same as Source</option>
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="9:16">9:16 (Portrait/Vertical)</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="4:3">4:3 (Standard)</option>
                    </select>
                </div>
            </div>

            <!-- Start Section -->
            <div class="card start-section">
                <button class="start-btn" id="startStream" disabled>
                    <span>&#9654;</span> Start Live Stream
                </button>

                <div class="status-panel" id="statusPanel">
                    <div class="status-header">
                        <div class="status-indicator">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="statusText">Streaming...</span>
                        </div>
                        <button class="stop-btn" id="stopStream">Stop Stream</button>
                    </div>
                    <div class="status-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="streamTime">00:00:00</div>
                            <div class="stat-label">Stream Time</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="loopNumber">1</div>
                            <div class="stat-label">Current Loop</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="dataTransferred">0 MB</div>
                            <div class="stat-label">Data Transferred</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Live Stream Repeater &mdash; Transform your videos into endless live streams</p>
        </footer>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:3000';

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const previewPlayer = document.getElementById('previewPlayer');
        const cropControls = document.getElementById('cropControls');
        const startBtn = document.getElementById('startStream');
        const statusPanel = document.getElementById('statusPanel');
        const scheduleBtns = document.querySelectorAll('.schedule-btn[data-schedule]');
        const scheduleInputs = document.getElementById('scheduleInputs');
        const streamDuration = document.getElementById('streamDuration');
        const customDuration = document.getElementById('customDuration');
        const infiniteLoop = document.getElementById('infiniteLoop');
        const loopCountOption = document.getElementById('loopCountOption');
        const toggleKeyBtn = document.getElementById('toggleKey');
        const streamKeyInput = document.getElementById('streamKey');
        const connectMetaBtn = document.getElementById('connectMeta');
        const serverStatusBanner = document.getElementById('serverStatus');

        let uploadedFile = null;
        let uploadedFilename = null;
        let isStreaming = false;
        let currentStreamId = null;
        let statusPollInterval = null;
        let serverConnected = false;
        let ffmpegInstalled = false;
        let currentUser = null;
        let userPlan = 'free';
        let planFeatures = null;

        // Check authentication on load
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' });
                if (response.ok) {
                    currentUser = await response.json();
                    userPlan = currentUser.plan || 'free';
                    updateAuthUI();
                    loadSubscriptionInfo();
                }
            } catch (e) {
                console.log('Not logged in');
            }
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            if (currentUser) {
                authButtons.innerHTML = `
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-name">${currentUser.name || currentUser.email}</div>
                            <div class="user-plan">${userPlan.toUpperCase()} Plan</div>
                        </div>
                        <button class="btn-logout" onclick="logout()">Log Out</button>
                    </div>
                `;
            }
        }

        async function loadSubscriptionInfo() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE}/api/billing/subscription/${currentUser.id}`, { credentials: 'include' });
                const data = await response.json();
                planFeatures = data.features;

                // Show upgrade banner for free users
                if (data.plan === 'free') {
                    const banner = document.getElementById('upgradeBanner');
                    banner.style.display = 'flex';
                    document.getElementById('usageText').textContent =
                        `${data.usage?.streams_this_month || 0}/${planFeatures.maxStreams} streams used this month`;
                }
            } catch (e) {
                console.log('Could not load subscription info');
            }
        }

        async function logout() {
            await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST', credentials: 'include' });
            currentUser = null;
            window.location.reload();
        }

        // Initialize auth check
        checkAuth();

        // Check server and FFmpeg status on load
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/check-ffmpeg`);
                const data = await response.json();

                serverConnected = true;
                ffmpegInstalled = data.installed;

                if (ffmpegInstalled) {
                    serverStatusBanner.innerHTML = `
                        <span class="icon" style="color: #4ade80;">&#10003;</span>
                        <p style="color: #4ade80;"><strong>Server connected!</strong> FFmpeg is installed. Ready to stream to YouTube, Twitch, Facebook, and more.</p>
                    `;
                    serverStatusBanner.style.background = 'rgba(74, 222, 128, 0.1)';
                    serverStatusBanner.style.borderColor = 'rgba(74, 222, 128, 0.3)';
                } else {
                    serverStatusBanner.innerHTML = `
                        <span class="icon">&#9888;</span>
                        <p><strong>FFmpeg not found!</strong> Please install FFmpeg to enable streaming.<br>
                        macOS: <code>brew install ffmpeg</code> | Windows: <code>choco install ffmpeg</code> | Linux: <code>sudo apt install ffmpeg</code></p>
                    `;
                }
            } catch (error) {
                serverConnected = false;
                serverStatusBanner.innerHTML = `
                    <span class="icon">&#9888;</span>
                    <p><strong>Server not running!</strong> Start the server with: <code>cd "Live Stream Repeater" && npm install && npm start</code><br>
                    Then refresh this page.</p>
                `;
            }
        }

        checkServerStatus();

        // File Upload Handling
        uploadArea.addEventListener('click', () => videoInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                handleVideoFile(file);
            }
        });

        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleVideoFile(file);
            }
        });

        async function handleVideoFile(file) {
            uploadedFile = file;
            const url = URL.createObjectURL(file);
            previewPlayer.src = url;

            previewPlayer.onloadedmetadata = async () => {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('videoDuration').textContent = formatTime(previewPlayer.duration);
                document.getElementById('videoResolution').textContent = `${previewPlayer.videoWidth}x${previewPlayer.videoHeight}`;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('endTime').value = formatTimeInput(previewPlayer.duration);

                videoPreview.classList.add('active');
                cropControls.style.display = 'block';

                // Upload to server if connected
                if (serverConnected) {
                    await uploadToServer(file);
                } else {
                    startBtn.disabled = false;
                }
            };
        }

        async function uploadToServer(file) {
            const uploadStatus = document.createElement('p');
            uploadStatus.style.cssText = 'margin-top: 10px; color: #fbbf24;';
            uploadStatus.textContent = 'Uploading to server...';
            document.getElementById('videoInfo').appendChild(uploadStatus);

            try {
                const formData = new FormData();
                formData.append('video', file);

                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedFilename = data.file.filename;
                    uploadStatus.style.color = '#4ade80';
                    uploadStatus.textContent = 'Uploaded to server successfully!';
                    startBtn.disabled = false;
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                uploadStatus.style.color = '#f87171';
                uploadStatus.textContent = `Upload failed: ${error.message}`;
                startBtn.disabled = true;
            }
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTimeInput(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function parseTime(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        function formatFileSize(bytes) {
            if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(2) + ' GB';
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(2) + ' MB';
            return (bytes / 1024).toFixed(2) + ' KB';
        }

        // Preview trimmed section
        document.getElementById('previewTrim').addEventListener('click', () => {
            const startTime = parseTime(document.getElementById('startTime').value);
            const endTime = parseTime(document.getElementById('endTime').value);

            if (startTime < endTime) {
                previewPlayer.currentTime = startTime;
                previewPlayer.play();

                const checkEnd = setInterval(() => {
                    if (previewPlayer.currentTime >= endTime) {
                        previewPlayer.pause();
                        previewPlayer.currentTime = startTime;
                        clearInterval(checkEnd);
                    }
                }, 100);
            }
        });

        // Schedule Options
        scheduleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                scheduleBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                scheduleInputs.style.display = btn.dataset.schedule === 'later' ? 'block' : 'none';
            });
        });

        // Duration Selection
        streamDuration.addEventListener('change', () => {
            customDuration.style.display = streamDuration.value === 'custom' ? 'block' : 'none';
        });

        // Loop Settings
        infiniteLoop.addEventListener('change', () => {
            loopCountOption.style.display = infiniteLoop.checked ? 'none' : 'flex';
        });

        // Toggle Stream Key Visibility
        toggleKeyBtn.addEventListener('click', () => {
            if (streamKeyInput.type === 'password') {
                streamKeyInput.type = 'text';
                toggleKeyBtn.textContent = 'Hide';
            } else {
                streamKeyInput.type = 'password';
                toggleKeyBtn.textContent = 'Show';
            }
        });

        // Meta Connect Button
        connectMetaBtn.addEventListener('click', () => {
            const fbRtmp = 'rtmps://live-api-s.facebook.com:443/rtmp/';
            document.getElementById('rtmpUrl').value = fbRtmp;
            alert('Facebook Live RTMP URL has been filled in!\n\nTo get your Stream Key:\n1. Go to facebook.com/live/producer\n2. Click "Go Live"\n3. Copy the "Stream Key" and paste it below\n\nNote: For Instagram Live, you need to use a third-party service as Instagram doesn\'t provide direct RTMP access.');
        });

        // Start Stream
        startBtn.addEventListener('click', async () => {
            if (!uploadedFile) {
                alert('Please upload a video first.');
                return;
            }

            const config = getStreamConfig();

            // Validate RTMP settings
            if (!config.rtmpUrl || !config.streamKey) {
                alert('Please enter an RTMP URL and Stream Key.\n\nYouTube: rtmp://a.rtmp.youtube.com/live2\nTwitch: rtmp://live.twitch.tv/app\nFacebook: rtmps://live-api-s.facebook.com:443/rtmp/');
                return;
            }

            // Check if scheduled for later
            if (config.scheduleType === 'later') {
                const scheduledTime = new Date(config.scheduleTime);
                const now = new Date();

                if (scheduledTime <= now) {
                    alert('Please select a future date and time.');
                    return;
                }

                alert(`Stream scheduled for ${scheduledTime.toLocaleString()}\n\nNote: Scheduling requires the server to remain running.`);
                return;
            }

            await startStreaming(config);
        });

        document.getElementById('stopStream').addEventListener('click', async () => {
            await stopStreaming();
        });

        function getStreamConfig() {
            return {
                filename: uploadedFilename,
                userId: currentUser?.id,
                startTime: parseTime(document.getElementById('startTime').value),
                endTime: parseTime(document.getElementById('endTime').value),
                scheduleType: document.querySelector('.schedule-btn.active').dataset.schedule,
                scheduleTime: document.getElementById('scheduleTime').value,
                duration: streamDuration.value === 'custom'
                    ? parseInt(document.getElementById('customDurationValue').value)
                    : parseInt(streamDuration.value),
                loop: infiniteLoop.checked,
                loopCount: infiniteLoop.checked ? -1 : parseInt(document.getElementById('loopCount').value),
                loopGap: parseInt(document.getElementById('loopGap').value),
                rtmpUrl: document.getElementById('rtmpUrl').value,
                streamKey: document.getElementById('streamKey').value,
                resolution: document.getElementById('outputResolution').value,
                frameRate: document.getElementById('frameRate').value,
                bitrate: document.getElementById('bitrate').value,
                aspectRatio: document.getElementById('aspectRatio').value
            };
        }

        async function startStreaming(config) {
            if (!serverConnected || !ffmpegInstalled) {
                alert('Server not connected or FFmpeg not installed. Please check the status banner at the top of the page.');
                return;
            }

            startBtn.disabled = true;
            startBtn.innerHTML = '<span>&#8987;</span> Starting Stream...';

            try {
                const response = await fetch(`${API_BASE}/api/stream/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    currentStreamId = data.streamId;
                    isStreaming = true;

                    startBtn.style.display = 'none';
                    statusPanel.classList.add('active');
                    document.getElementById('statusDot').classList.remove('stopped');
                    document.getElementById('statusText').textContent = 'Streaming...';

                    // Start polling for status
                    statusPollInterval = setInterval(pollStreamStatus, 1000);
                } else if (data.upgrade) {
                    // User hit their plan limit
                    if (confirm(`${data.error}\n\nWould you like to upgrade your plan?`)) {
                        window.location.href = '/pricing';
                    }
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<span>&#9654;</span> Start Live Stream';
                } else {
                    throw new Error(data.error || 'Failed to start stream');
                }
            } catch (error) {
                alert(`Failed to start stream: ${error.message}`);
                startBtn.disabled = false;
                startBtn.innerHTML = '<span>&#9654;</span> Start Live Stream';
            }
        }

        async function pollStreamStatus() {
            if (!currentStreamId) return;

            try {
                const response = await fetch(`${API_BASE}/api/stream/status/${currentStreamId}`);
                const data = await response.json();

                if (data.status === 'running') {
                    document.getElementById('streamTime').textContent = data.stats.time || '00:00:00';
                    document.getElementById('loopNumber').textContent = data.stats.loopCount || 1;

                    // Calculate approximate data transferred
                    const timeParts = (data.stats.time || '00:00:00').split(':');
                    const seconds = parseInt(timeParts[0]) * 3600 + parseInt(timeParts[1]) * 60 + parseInt(timeParts[2] || 0);
                    const dataMB = (seconds * 0.5).toFixed(1);
                    document.getElementById('dataTransferred').textContent = `${dataMB} MB`;
                } else if (data.status === 'stopped' || data.status === 'completed' || data.status === 'error') {
                    clearInterval(statusPollInterval);
                    document.getElementById('statusDot').classList.add('stopped');
                    document.getElementById('statusText').textContent = data.status === 'error' ? 'Stream Error' : 'Stream Ended';

                    setTimeout(() => {
                        statusPanel.classList.remove('active');
                        startBtn.style.display = 'flex';
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<span>&#9654;</span> Start Live Stream';
                        isStreaming = false;
                        currentStreamId = null;
                    }, 3000);
                }
            } catch (error) {
                console.error('Failed to poll status:', error);
            }
        }

        async function stopStreaming() {
            if (!currentStreamId) return;

            try {
                const response = await fetch(`${API_BASE}/api/stream/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ streamId: currentStreamId })
                });

                const data = await response.json();

                if (data.success) {
                    clearInterval(statusPollInterval);
                    document.getElementById('statusDot').classList.add('stopped');
                    document.getElementById('statusText').textContent = 'Stream Stopped';

                    setTimeout(() => {
                        statusPanel.classList.remove('active');
                        startBtn.style.display = 'flex';
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<span>&#9654;</span> Start Live Stream';
                        isStreaming = false;
                        currentStreamId = null;
                    }, 2000);
                }
            } catch (error) {
                alert(`Failed to stop stream: ${error.message}`);
            }
        }

        // Set default schedule time to now + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('scheduleTime').value = now.toISOString().slice(0, 16);
    </script>
</body>
</html>
